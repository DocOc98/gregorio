%GregorioTeX file.
%
% Copyright (C) 2007-2015 The Gregorio Project (see CONTRIBUTORS.md)
%
% This file is part of Gregorio.
%
% Gregorio is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% Gregorio is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Gregorio.  If not, see <http://www.gnu.org/licenses/>.


% this file contains definitions of signs (bar, episemus, punctum, alterations)

\gre@declarefileversion{gregoriotex-signs.tex}{3.0.2}% GREGORIO_VERSION

\def\greusestylecommon{%
  \ifnum\greusestylefont=0\relax %
    \xdef\greusestylefont{1}%
    \gresetstylefont %
  \fi %
  \relax %
}%

\greusedefaultstyle%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for discretionaries
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% In order to avoid clef change at beginning or end of line, we use discretionaries
% for clef change, or even with more complex data (z0::c3 for instance). The problem
% with discretionaries is that:
% - you cannot use \hskip (but you can use kern)
% - you cannot use \penalty (which is useless indeed)
%
% To remedy that, we define \grehskip to be \hskip outside a discretionary, and
% \kern inside a discretionary. This is what these macros do:

\def\grefalsepenalty#1{}%
\def\gretruepenalty#1{\penalty#1}%

\let\grehskip\hskip%
\let\grepenalty\gretruepenalty%
\xdef\greinsidediscretionary{\number 0}%

\def\GreDiscretionary#1#2{%
  \global\let\grehskip\kern %
  \global\let\grepenalty\grefalsepenalty %
  \global\xdef\greinsidediscretionary{\number 1}%
  \discretionary{%
    \global\grelastoflinecount=1\relax % (a good magic trick)
    #1%
    \gre@skip@temp@four = \grekernbeforeeol\relax%
    \kern\gre@skip@temp@four %
    }{%
    \global\grelastoflinecount=2\relax % (a good magic trick)
    }{%
    #2%
    }%
  \global\xdef\greinsidediscretionary{\number 0}%
  \global\let\grehskip\hskip %
  \global\let\grepenalty\gretruepenalty %
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the clefs of the beginning of lines and custos
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% flag for showing the clef
\newif\ifgre@showclef%
\gre@showcleftrue

\def\gresetclef#1{%
  \IfStrEq{#1}{visible}%
    {\gre@showcleftrue}%
    {\IfStrEq{#1}{invisible}%
      {\gre@showcleffalse}
      {\greerror{Unrecognized option for \protect\gresetclef}}%
    }%
}%


\def\greremoveclef{%
  \gre@deprecated{\protect\greremoveclef}{\protect\gresetclef{invisible}}%
  \gresetclef{invisible}%
}%

\def\grenormalclef{%
  \gre@deprecated{\protect\grenormalclef}{\protect\gresetclef{visible}}%
  \gresetclef{visible}%
}%

% a count describing the clef line and pitch : 1 for c on the first (bottom) line, 2 for c on the second line, 5 for f on the first, etc.
\newcount\greclefnum%

%% marcro to define the clef that will appear at the beginning of the lines
% the first argument is the type : f or c, and the second is the height
% the third argument is whether we must type a space after or not (0 if not, 1 if yes)
% if the fourth argument is a, it means that we must not put a flat after the key, otherwise it's the height of the flat
\def\GreSetLinesClef#1#2#3#4{%
  \grelocalleftbox{%
    \gre@skip@temp@four = \gre@dimen@additionalleftspace%
    \kern\gre@skip@temp@four %
    \copy\gre@box@lines% draws the lines
    \unkern %
    \ifgre@showclef%
      \gre@skip@temp@four = \gre@skip@afterclefnospace%
      \hbox{\gretypekey{#1}{#2}{0}{#3}{#4}\hskip\gre@skip@temp@four}%
    \else %
      \gre@skip@temp@four = \gre@dimen@noclefspace%
      \hbox{\kern\gre@skip@temp@four}%
    \fi %
  }%
  \xdef\greclefflat{#4}%
  \relax%
}%

%% macro calculating the \greclefnum from the letter and number
% #1 is the letter, and #2 the line number, #3 is a if not flated
% and otherwise the height of the flat
\def\grecalculateclefnum#1#2#3{%
  \global\greclefnum=#2\relax %
  \ifx f#1%
    \global\advance\greclefnum by 4\relax %
  \fi %
  \relax %
}%

%% macro redrawing a key from clefnum, useful for vertical space changes
\def\greupdatelinesclef{%
  \ifnum\greclefnum > 5\relax%
    \gre@count@temp@three=\greclefnum %
    \advance\gre@count@temp@three by -4\relax %
    \GreSetLinesClef{f}{\gre@count@temp@three}{1}{\greclefflat}%
  \else %
    \GreSetLinesClef{c}{\greclefnum}{1}{\greclefflat}%
  \fi %
  \relax %
}%

% macro that typesets the key
% arguments are : 
%% #1: the type of the key : c or f
%% #2: the line of the key (1 is the lowest)
%% #3: if we must use small key characters (inside a line) or not 0: if not inside, 1 if inside
%% #4: if we must type a space after or not
%% #5: if 3, it means that we must not put a flat after the key, otherwise it's the height of the flat
\def\gretypekey#1#2#3#4#5{%
  \ifcase#2 %
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@c}{0}%
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@e}{0}%
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@g}{0}%
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@i}{0}%
  \fi%
  \gre@skip@temp@two=\gre@skip@spaceafterlineclef %
  \ifnum#4=0\relax %
    \gre@skip@temp@two=\gre@skip@afterclefnospace %
  \fi %
  \ifx c#1% we check if it is a c key
    \ifcase#3%
      \raise\gre@dimen@glyphraisevalue\hbox{\grecclefchar}%\hskip\gre@skip@temp@two}
      \setbox\gre@box@temp@width=\hbox{\grecclefchar}%
      \global\gre@dimen@clefwidth=\wd\gre@box@temp@width %
    \or%
      \raise\gre@dimen@glyphraisevalue\hbox{\greincclefchar}%\hskip\gre@skip@temp@two}
    \fi%
  \else % we consider that it is a f key
    \ifcase#3%
      \raise\gre@dimen@glyphraisevalue\hbox{\grefclefchar}%\hskip\gre@skip@temp@two}
      \setbox\gre@box@temp@width=\hbox{\grefclefchar}%
      \global\gre@dimen@clefwidth=\wd\gre@box@temp@width %
    \or%
      \raise\gre@dimen@glyphraisevalue\hbox{\greinfclefchar}%\hskip\gre@skip@temp@two}
    \fi%
  \fi%
  \ifnum#5=3%
    \grehskip\gre@skip@temp@two %
  \else %
    \gre@skip@temp@four = \gre@skip@clefflatspace%
    \grehskip\gre@skip@temp@four %
    \GreFlat{#5}{1}%
    \grehskip\gre@skip@temp@two %
  \fi %
  \relax %
}%

% macro that writes the initial key, and sets the next keys to the same value
% if #3 is a, it means that we must not put a flat after the key, otherwise it's the height
% of the flat
\def\GreSetInitialClef#1#2#3{%
  \grecalculateclefnum{#1}{#2}{#3}%
  \ifgre@showclef%
    \gretypekey{#1}{#2}{0}{1}{#3}%
  \fi %
  \GreSetLinesClef{#1}{#2}{1}{#3}%
  % if the initial is big, then we adjust the second line
  \ifnum\grebiginitial=0\relax %
  \else %
    \GreAdjustSecondLine %
  \fi %
  \relax%
}%

% macro called when the key changes
% #1 and #2 are the type and line of the clef
% #3 is 1 or 0 according to the need of a space before the clef. Useful for clefs after bars for example
% if #4 is a, it means that we must not put a flat after the key, otherwise it's the height
% of the flat
\def\GreChangeClef#1#2#3#4{%
  % it makes no sense to change the clef when there is no clef...
  \gresetclef{visible}%
  \grecalculateclefnum{#1}{#2}{#4}%
  \ifnum\greinsidediscretionary=0\relax %
    \GreSetLinesClef{#1}{#2}{1}{#4}%
  \fi %
  \ifnum#3=1\relax %
    \gre@skip@temp@four = \gre@skip@clefchangespace%
    \grehskip\gre@skip@temp@four %
  \else %
    % here it means that there is a bar before the clef, so we skip the difference between the normal space and the space around bars with clef changes
    \gre@skip@temp@four = -\gre@skip@spacearoundclefbars%
    \grehskip\gre@skip@temp@four %
  \fi %
  \gretypekey{#1}{#2}{1}{0}{#4}%
  \gre@skip@temp@four = \gre@skip@clefchangespace%
  \grehskip\gre@skip@temp@four %
  \relax%
}%

% macro called when the key changes inside a syllable
% doesn't seem to be used; was some code lost somewhere?

\def\greinchangeclef#1#2#3{%
  \gresetclef{visible}%
  % to see why we reset \grelastoflinecount, see comments of \GreGlyph.
  \ifnum\grelastoflinecount=2\relax %
    \global\grelastoflinecount=0\relax %
  \fi %
  \ifnum\greinsidediscretionary=0\relax %
    \GreSetLinesClef{#1}{#2}{0}{#3}%
  \fi %
  \gre@skip@temp@four = \gre@skip@clefchangespace%
  \hskip\gre@skip@temp@four %
  \gretypekey{#1}{#2}{1}{0}{#3}%
  \hskip\gre@skip@temp@four %
  \relax%
}%

% custo just typesets a custo, useful for before the key changes for example
\def\GreCusto#1{%
  \gre@calculate@glyphraisevalue{#1}{0}%
  %here we need some tricks to draw the line before the custo (for the color)
  \setbox\gre@box@temp@width=\hbox{\grecustochar{#1}}%
  \gre@dimen@temp@three=\wd\gre@box@temp@width %
  \ifgre@showlines %
    \ifnum#1=\gre@pitch@a\relax %
      \greadditionalbottomcustolinemiddle %
    \else\ifnum#1=\gre@pitch@b\relax %
      \greadditionalbottomcustolinemiddle %
    \else\ifnum#1=\gre@pitch@l\relax %
      \greadditionaltopcustolinemiddle %
    \else\ifnum#1=\gre@pitch@m\relax %
      \greadditionaltopcustolinemiddle %
    \fi\fi\fi\fi %
  \fi %
  \raise \gre@dimen@glyphraisevalue%
  \copy\gre@box@temp@width %
  % for now we consider we always have a bar after the custo
  % we don't want to end the line here
  \grenobreak %
  \gre@skip@temp@four = -\gre@skip@spacearoundclefbars%
  \grehskip\gre@skip@temp@four %
  \grenobreak %
  \relax %
}%

% the argument is the height
\def\gresetcusto#1{%
  \ifnum\greinsidediscretionary=0\relax %
    \ifgre@blockeolcustos\else%
      \gre@calculate@glyphraisevalue{#1}{0}%
      %here we need some tricks to draw the line before the custo (for the color)
      \setbox\gre@box@temp@width=\hbox{%
      % we type a hskip and the we type the custo
      \gre@skip@temp@four = \gre@skip@spacebeforecusto%
      \hskip\gre@skip@temp@four %
      \grecustochar{#1}\relax %
      }%
      \gre@dimen@temp@three=\wd\gre@box@temp@width %
      % we make \wd\gre@box@temp@sign contain the width of a custo
      \setbox\gre@box@temp@sign=\hbox{%
      \grecustochar{#1}\relax %
      }%
      \grelocalrightbox{%
      \ifgre@showlines %
        \ifnum#1=\gre@pitch@a\relax %
          \greadditionalbottomcustolineend %
        \else\ifnum#1=\gre@pitch@b\relax %
          \greadditionalbottomcustolineend %
        \else\ifnum#1=\gre@pitch@l\relax %
          \greadditionaltopcustolineend %
        \else\ifnum#1=\gre@pitch@m\relax %
          \greadditionaltopcustolineend %
        \fi\fi\fi\fi %
      \fi %
      \raise \gre@dimen@glyphraisevalue%
      \copy\gre@box@temp@width %
      }%
    \fi %
  \fi %
  \relax%
}%

\def\GreManualCusto#1{%
  \gre@skip@temp@four = \gre@skip@spacebeforecusto%
  \kern\gre@skip@temp@four\GreCusto{#1}%
}%

% macro that typesets an additional line at the top for custos at end of line

\def\greadditionaltopcustolineend{%
  \gre@dimen@temp@five=\gre@dimen@staffheight %
  \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \gre@style@additionalstafflines %
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@five by \gre@dimen@additionalcustoslineswidth %
    \kern-\gre@dimen@temp@five %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \endgre@style@additionalstafflines%
  }%
  \relax %
}%

\def\greadditionalbottomcustolineend{%
  \gre@dimen@temp@five=\gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \advance\gre@dimen@temp@five by -\gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by -\gre@dimen@stafflineheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \gre@style@additionalstafflines %
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@five by \gre@dimen@additionalcustoslineswidth %
    \kern-\gre@dimen@temp@five %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \endgre@style@additionalstafflines %
  }%
  \relax %
}%

% same macros, but for a custo in the middle

\def\greadditionaltopcustolinemiddle{%
  \gre@dimen@temp@five=\gre@dimen@staffheight %
  \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \gre@style@additionalstafflines %
    \hss %
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\gre@dimen@additionalcustoslineswidth %
    \multiply\gre@dimen@temp@five by 2%
    \advance\gre@dimen@temp@five by \wd\gre@box@temp@sign %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \endgre@style@additionalstafflines%
  }%
  \relax %
}%

\def\greadditionalbottomcustolinemiddle{%
  \gre@dimen@temp@five=\gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \advance\gre@dimen@temp@five by -\gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by -\gre@dimen@stafflineheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \gre@style@additionalstafflines %
    \hss %
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\gre@dimen@additionalcustoslineswidth %
    \multiply\gre@dimen@temp@five by 2%
    \advance\gre@dimen@temp@five by \wd\gre@box@temp@sign %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \endgre@style@additionalstafflines%
  }%
  \relax %
}%

\def\grecustochar#1{%
  \ifcase#1%
  \or\or%
  \or\grecustotopmiddlechar %
  \or\grecustotoplongchar %
  \or\grecustotopshortchar %
  \or\grecustotoplongchar %
  \or\grecustotopshortchar %
  \or\grecustotoplongchar %
  \or\grecustotopshortchar %
  \or\grecustotoplongchar %
  \or\grecustotopshortchar %
  \or\grecustobottomlongchar %
  \or\grecustobottomshortchar %
  \or\grecustobottomlongchar %
  \or\grecustobottommiddlechar %
  \fi%
}%

\def\removecusto{%
  \grelocalrightbox{}%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of braces and other things above the score
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\gdef\grecurlybracechar{\gregoriofont\gre@char@curlybrace}%
\gdef\grebracechar{\gregoriofont\gre@char@brace}%
\gdef\greunderbracechar{\gregoriofont\gre@char@bracedown}%

% the command to resize a box, \resizebox is provided by graphicx
\global\let\greresizebox\resizebox %

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
% #5: 1 if we put an accentus above or not
\def\greovercurlybrace#1#2#3#4#5{%
  \grebracecommon{#1}{#2}{#3}{#4}{#5}{\gre@pitch@g}{\grecurlybracechar}%
}%

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
\def\greoverbrace#1#2#3#4{%
  \grebracecommon{#1}{#2}{#3}{#4}{0}{\gre@pitch@g}{\grebracechar}%
}%

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
\def\greunderbrace#1#2#3#4{%
  \grebracecommon{#1}{#2}{#3}{#4}{0}{\gre@pitch@b}{\greunderbracechar}%
}%

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
% #5: 1 if we put an accentus above, 0 if not
% #6: the pitch at which to compute the height
% #7: the brace character
\def\grebracecommon#1#2#3#4#5#6#7{%
  \ifnum#4=1\relax %
    \setbox\gre@box@temp@sign=\hbox{\grepunctumchar}%
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \kern-\gre@dimen@temp@five %
  \fi %
  \gre@calculate@glyphraisevalue{#6}{13}%
  \advance\gre@dimen@glyphraisevalue by #2\relax %
  \setbox\gre@box@temp@sign=\hbox{#7}%
  \hbox to 0pt{%
    \gre@skip@temp@four = #3\relax %
    \kern\gre@skip@temp@four %
    \raise\gre@dimen@glyphraisevalue\hbox{%
%      \greresizebox{#1}{\dimexpr\ht\gre@box@temp@sign+\dp\gre@box@temp@sign}{#6}%
      \greresizebox{#1}{\ht\gre@box@temp@sign}{#7}%
    }%
    \hss %
    \ifnum#5=1\relax %
      \gre@calculate@glyphraisevalue{\gre@pitch@m}{13}%
      \advance\gre@dimen@glyphraisevalue by \gre@dimen@curlybraceaccentusshift %
      \raise\gre@dimen@glyphraisevalue\hbox{%
        \gregoriofont\gre@char@accentus\relax %
      }%
      \hss %
    \fi %
  }%
  \ifnum#4=1\relax %
    \kern\gre@dimen@temp@five %
  \fi %
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of punctum mora, auctum duplex and choral signs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a function to typeset a punctum mora, the first argument is the letter of the height of the punctum mora
% if the second argument is one, we the go back to the end of the punctum
% if the second argument is two, it means that we must shift the width of one punctum to the left
% if it is three, it means the same as when it is two, but with ambitus of one
% #3 is 1 in case of a punctommora in the note before the last note of a podatus, porrectus or torculus resupinus, 0 otherwise.
% #4 is 1 if we are at a punctum inclinatum, 0 otherwise
\def\GrePunctumMora#1#2#3#4{%
  \grenobreak %
  \ifcase#2\relax %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \hskip\gre@skip@temp@four%
  \or %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \or %
    % to get the widht of a punctum minus a line, we calculate the width of a flexus (with ambitus of two) minus the width of a punctum
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@flexus}%
    \gre@dimen@temp@five=\wd\gre@box@temp@width %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@punctum}%
    \advance\gre@dimen@temp@five by -\wd\gre@box@temp@width %
    \kern-\gre@dimen@temp@five %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \or %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@punctum}%
    \gre@dimen@temp@five=\wd\gre@box@temp@width %
    \kern-\gre@dimen@temp@five %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \fi %
  \ifnum#2=1\else %
    \xdef\grelastispunctum{1}%
  \fi %
  \ifcase#3\relax % 0
    \gre@calculate@glyphraisevalue{#1}{4}%
  \or% 1
    \gre@calculate@glyphraisevalue{#1}{8}%
  \or% 2
    \gre@calculate@glyphraisevalue{#1}{14}%
  \fi %
  % here we shift a bit left in the case where we have a punctum inclinatum on a line
  \ifnum#4=1\relax %
    \ifnum\greisonaline=1\relax %
      \gre@dimen@temp@three=3700sp%
      \multiply\gre@dimen@temp@three by \the\grefactor %
      \kern-\gre@dimen@temp@three %
      \gre@dimen@temp@three =4500sp%
      \multiply\gre@dimen@temp@three by \the\grefactor %
      \advance\gre@dimen@glyphraisevalue by -\gre@dimen@temp@three %
    \else %
      \gre@dimen@temp@three =2500sp%
      \multiply\gre@dimen@temp@three by \the\grefactor %
      \advance\gre@dimen@glyphraisevalue by -\gre@dimen@temp@three %
    \fi %
  \fi %
  \grenobreak %
  \raise \gre@dimen@glyphraisevalue \hbox{\grepunctummorachar}%
  \grenobreak %
  \ifcase#2\relax\or %
    \setbox\gre@box@temp@width=\hbox{\grepunctummorachar}%
    \gre@skip@temp@four = -\wd\gre@box@temp@width %
    \kern\gre@skip@temp@four%
    \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \or %
    \setbox\gre@box@temp@width=\hbox{\grepunctummorachar}%
    \gre@skip@temp@four = -\wd\gre@box@temp@width %
    \kern\gre@skip@temp@four%
    \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
    \kern\gre@dimen@temp@five %
  \or %
    \setbox\gre@box@temp@width=\hbox{\grepunctummorachar}%
    \gre@skip@temp@four = -\wd\gre@box@temp@width %
    \kern\gre@skip@temp@four%
    \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
    \kern\gre@dimen@temp@five %
  \fi %
  \grenobreak %
  \relax%
}%

% a function to typeset an augmentum duplex, easy enough to be understood...
\def\GreAugmentumDuplex#1#2#3{%
  \GrePunctumMora{#1}{1}{#3}{0}%
  \GrePunctumMora{#2}{0}{0}{0}%
  \relax %
}%

\gdef\grelowchoralsignstyle#1{#1}%
\gdef\grehighchoralsignstyle#1{#1}%

% quite simple function: #1 is the height, #2 is the string, #3 is #2 of punctum mora, #4 is #3 of punctum mora
% #3 is 1 if it must be a bit higher
\def\GreLowChoralSign#1#2#3{%
  \grenobreak %
  \gre@skip@temp@four = \gre@skip@beforelowchoralsignspace%
  \hskip\gre@skip@temp@four %
  \grenobreak %
  \ifnum#3=1\relax %
    \gre@calculate@glyphraisevalue{#1}{12}%
  \else %
    \gre@calculate@glyphraisevalue{#1}{10}%
  \fi %
  \raise\gre@dimen@glyphraisevalue\hbox{{\gre@style@lowchoralsign\grelowchoralsignstyle{#2}\endgre@style@lowchoralsign}}%
  \relax %
}%

\def\GreHighChoralSign#1#2#3{%
  \grenobreak %
  \grevepisemusorrare{#1}{#3}{}{3}{{\gre@style@highchoralsign\grehighchoralsignstyle{#2}\endgre@style@highchoralsign}}%
  %\grehepisorline{#1}{#3}{0}{4}{{\gre@style@highchoralsign\grehighchoralsignstyle{#2}\endgre@style@highchoralsign}}
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of linea
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\GreLinea#1#2#3{%
  \GreGlyph{\gre@char@linea}{#1}{#2}{#3}{}{}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of vertical episemus
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newbox\gre@box@temp@sign%

% a macro to help typesetting vertical episemus.
% #1 is an offset glyph (see #3 below)
% #2 represents the glyph upon which the sign is to be centered
% #3 is a case number
%    0 : go back to the beginning of the previous glyph and then forward half
%        the width of #2; this puts the sign at the beginning of the previous
%        glyph, whose first note is the size of #2
%    1 : go back half the width of #2; this puts the sign at the end of the
%        previous glyph, whose last note is the size of #2
%    2 : go back the width of #1 and then foward half the width of #2; this
%        puts the sign at the glyph from the end that starts at #1's width from
%        the end
%    3 : go back to the beginning of the previous glyph and then forward the
%        width of #1 and then back half the width of #2; this puts the sign at
%        the glyph from the start that ends at #1's width from the start
% #4 is a shift that we want to get applied, useful for punctum inclinatum for example
% #5 is the glyph number.
% #6 is the type of sign (1: vertical episemus, 2: rare sign, 3: choral sign)
% #7 is the choral sign if relevant
\def\grevepisemusorrareaux#1#2#3#4#5#6#7{%
  % first we set \gre@dimen@temp@three to the width of the last glyph
  \gre@dimen@temp@three=\gre@dimen@lastglyphwidth %
  \setbox\gre@box@temp@sign=\hbox{\gregoriofont #2}%
  \gre@dimen@temp@two=\wd\gre@box@temp@sign %
  \divide\gre@dimen@temp@two by 2\relax %
  \ifcase#3%
  % tempwidth is the width of the last glyph
    \advance\gre@dimen@temp@three by -\gre@dimen@temp@two %
  \or%
    \gre@dimen@temp@three=\gre@dimen@temp@two %
  \or%
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \gre@dimen@temp@three=\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@three by -\gre@dimen@temp@two %
  \or %
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \advance\gre@dimen@temp@three by -\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@three by \gre@dimen@temp@two %
  \fi%
  \kern-\gre@dimen@temp@three % we do it here because of the now-removed ictus (chironomy)
  % then we draw the sign
  \ifcase#6\or %
    % vertical episemus
    \setbox\gre@box@temp@sign=\hbox{\greverticalepisemuschar}%
  \or % rare sign
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont#5}%
  \or % choral sign
    \setbox\gre@box@temp@sign=\hbox{#7}%
  \or % brace above bar
    \setbox\gre@box@temp@sign=\hbox{\greabovebarbracechar}%
  \fi %
  % we set tempwidth to half a punctum malus half the sign width, so that the centers are aligned
  \gre@dimen@temp@two=\wd\gre@box@temp@sign %
  \divide\gre@dimen@temp@two by 2 %
  \advance\gre@dimen@temp@three by \gre@dimen@temp@two %
  \kern-\gre@dimen@temp@two%
  \gre@skip@temp@four = #4sp%
  \kern \gre@skip@temp@four%
  \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \kern -\gre@skip@temp@four%
  % and finally we go back to the end of the glyph, where we were first
  \advance\gre@dimen@temp@three by -2\gre@dimen@temp@two %
  \kern\gre@dimen@temp@three%
  \relax%
}%

\directlua{gregoriotex.emit_offset_macros()}%

% adapted from http://www.tug.org/TUGboat/Articles/tb13-1/tb34fine.pdf
\let\gre@switchx@fi\fi%
\def\gre@switchx#1#2#3{%
  \ifx#1#2\gre@switchx@break#3\gre@switchx@fi%
  \gre@switchx#1%
}%
\def\gre@switchx@break#1\gre@switchx@fi#2\gre@endswitchx{\fi#1}%

% a function to typeset a vertical episemus or a rare accent (like accentus,
% circulus, etc.).  This function must be called after a call to \GreGlyph.
% #1 is the letter of the height of the episemus (not the height of the note
%    it corresponds to.
% #2 is note position case as in the table above
% #3 is the sign glyph
% #4 is type (1: vertical episemus, 2: rare sign, 3: choral sign, 4: brace above the bar)
% #5 is the choral sign if relevant
\def\grevepisemusorrare#1#2#3#4#5{%
  \ifcase#4\or %
    % if it is a vertical episemus, we call the normal calculateglyphvalue
    \gre@calculate@glyphraisevalue{#1}{3}%
  \or %
    % if it is not, we call it with 6 as second argument, it will give us the height of the rare signs (accentus, etc.) the first argument is m if the pitch is < k, otherwise it's n.
    \ifnum#1<\gre@pitch@k\relax %
      \gre@calculate@glyphraisevalue{\gre@pitch@k}{6}%
    \else %
      {%
        \gre@count@temp@three=#1%
        \advance\gre@count@temp@three by 1\relax %
        \gre@calculate@glyphraisevalue{\gre@count@temp@three}{6}%
      }%
    \fi %
  \or % if it's a choral sign
    \gre@calculate@glyphraisevalue{#1}{11}%
  \or % if it's the brace above the bar
    \gre@calculate@glyphraisevalue{#1}{13}%
  \fi %
  \gre@v@case{#2}{#3}{#4}{#5}%
  \relax%
}%

\def\GreVEpisemus#1#2{%
  \grevepisemusorrare{#1}{#2}{\gre@char@vepisemus}{1}{}%
  \relax %
}%

\def\GreBarBrace#1{%
  \grevepisemusorrare{\gre@pitch@g}{#1}{\gre@char@barbrace}{4}{}%
  \relax %
}%

\def\GreBarVEpisemus#1{%
  \grevepisemusorrare{\gre@pitch@c}{#1}{\gre@char@vepisemus}{1}{}%
  \relax %
}%

\def\GreAccentus#1#2{%
  \grevepisemusorrare{#1}{#2}{\gre@char@accentus}{2}{}%
  \relax %
}%

\def\GreSemicirculus#1#2{%
  \grevepisemusorrare{#1}{#2}{\gre@char@semicirculus}{2}{}%
  \relax %
}%

\def\GreCirculus#1#2{%
  \grevepisemusorrare{#1}{#2}{\gre@char@circulus}{2}{}%
  \relax %
}%

\def\GreReversedAccentus#1#2{%
  \grevepisemusorrare{#1}{#2}{\gre@char@reversedaccentus}{2}{}%
  \relax %
}%

\def\GreReversedSemicirculus#1#2{%
  \grevepisemusorrare{#1}{#2}{\gre@char@reversedsemicirculus}{2}{}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting horizontal episemus
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% a macro that will help in the typesetting of a horizontal episemus and additional lines,
% #1 is an offset glyph (see #3, below)
% #2 is the episemus glyph
% #3 is a case number, similar in nature to #3 in grevepisemusorrareaux
%    0 : go back to the beginning of the previous glyph; this starts the
%        episemus at the beginning of the previous glyph
%    1 : stay at the end of the glyph; doesn't make much sense to use this
%    2 : go back the width of #1; this starts the episemus at the glyph from
%        the end that starts at #1's width from the end
%    3 : go back to the beginning of the previous glyph and then forward the
%        width of #1; this starts the episemus at the glyph from the start that
%        starts just after #1's width from the start
% #4 argument is the same as in hepisorline
\def\grehepisorlineaux#1#2#3#4{%
  \ifcase#3%
    % case 0
  % first we set \gre@dimen@temp@three to the width of the last glyph
    \gre@dimen@temp@three=\gre@dimen@lastglyphwidth %
  \or
    % case 1
    \gre@dimen@temp@three=0 pt\relax %
  \or
    % case 2
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \gre@dimen@temp@three=\wd\gre@box@temp@sign%
  \or
    % case 3
    \gre@dimen@temp@three=\gre@dimen@lastglyphwidth %
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \advance\gre@dimen@temp@three by -\wd\gre@box@temp@sign %
  \fi%
  \kern-\gre@dimen@temp@three %
  % then we draw the sign, and go back to the beginning of the sign
  \setbox\gre@box@temp@sign=\hbox{\gregoriofont#2}%
  % we set tempwidth to half a punctum malus half the sign width, so that the centers are aligned
  \gre@dimen@temp@two=\wd\gre@box@temp@sign %
  \ifnum#4<2\relax % case of the lines
  \else %
    \gre@dimen@temp@five=\gre@dimen@additionallineswidth %
    \kern-\gre@dimen@temp@five %
    \advance\gre@dimen@temp@two by 2\gre@dimen@temp@five %
  \fi %
  \ifcase#4%
    %case of hepisemus
    \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \or %
    %case of hepisemus at the bottom
    \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \or % case of a line at the top
    \gre@dimen@glyphraisevalue=\gre@dimen@additionalbottomspace %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacelinestext %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@currenttranslationheight %
    \advance\gre@dimen@glyphraisevalue by 4\gre@dimen@interstafflinespace %
    \advance\gre@dimen@glyphraisevalue by 4\gre@dimen@stafflineheight %
    \raise\gre@dimen@glyphraisevalue\hbox{\vrule height \gre@dimen@stafflineheight width \gre@dimen@temp@two}%
    \kern\gre@dimen@temp@five %
  \or % case of a line at the bottom
    \gre@dimen@glyphraisevalue=\gre@dimen@additionalbottomspace %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@currenttranslationheight %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacelinestext %
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@interstafflinespace %
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflineheight %
    \raise\gre@dimen@glyphraisevalue\hbox{\vrule height \gre@dimen@stafflineheight width \gre@dimen@temp@two}%
    \kern\gre@dimen@temp@five %
  \or %
    %case of choral sign
    \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \or %
  \fi %
  % and finally we go back to the end of the glyph, where we were first
  \advance\gre@dimen@temp@three by -\gre@dimen@temp@two %
  \kern\gre@dimen@temp@three %
  \relax%
}%

% a function to typeset a horizontal line (additional line or episemus).
% This function must be called after a call to \GreGlyph.
% #1 is the letter of the height of the episemus (not the height of the note
% it corresponds to.
% #2 is note position case as in the table above
% #3 is the ambitus for a two note episemus at the diagonal stroke of a
%    porrectus, porrectus flexus, orculus resupinus, or torculus resupinus
%    flexus
% #4 is 0 for an horizontal episemus, 1 for an horizontal episemus under a
%    note, 3 for a line at the bottom, 2 for a line at the top
% #5 is f for a normal episemus, l for a small episemus aligned left,
%    c for a small episemus aligned center, or r for a small episemus
%    aligned right
\def\grehepisorline#1#2#3#4#5{{%
  \ifcase#4 %
    \gre@calculate@glyphraisevalue{#1}{9}%
  \or %
    \gre@calculate@glyphraisevalue{#1}{5}%
  \or %
    % the glyphraisevalue is ignored anyway... but it's just in case...
    \gre@calculate@glyphraisevalue{\gre@pitch@l}{0}%
  \or %
    \gre@calculate@glyphraisevalue{\gre@pitch@b}{0}%
  \or %
    \gre@calculate@glyphraisevalue{#1}{11}%
  \fi %
  \gre@h@case{#2}{#3}{#4}{#5}%
  \relax%
}}%

% dumb top function
% #6 is a trick for bridges: if we must use a different height because of a
%    bridge, use #6, otherwise use #1
\def\GreHEpisemus#1#2#3#4#5#6{%
  \ifgre@hepisemusbridge%
    \grehepisorline{#6}{#2}{#3}{#4}{#5}%
  \else %
    \grehepisorline{#1}{#2}{#3}{#4}{#5}%
  \fi %
  \relax %
}%

\newif\ifgre@hepisemusbridge
\gre@hepisemusbridgetrue

\def\AddHEpisemusBridges{%
  \gre@deprecated{\protect\AddHEpisemusBridges}{\protect\gresethepisemus{bridge}}%
  \gre@hepisemusbridgestrue%
}%

\def\RemoveHEpisemusBridges{%
  \gre@deprecated{\protect\RemoveHepisemusBridges}{\protect\gresethepisemus{break}}
}%

\def\gresethepisemus#1{%
  \IfStrEq{#1}{bridge}%
    {\gre@hepisemusbridgetrue}%
    {\IfStrEq{#1}{break}%
      {\gre@hepisemusbridgefalse}%
      {\greerror{Unrecognized option for \protect\gresethepisemus}}%
    }%
}%

% same but for a "bridge episemus" after the last note of a glyph (element, syllable) if the next episemus is at the same height
% #1 is the height
% #2 is 0 for episemus above, 1 for episemus below
\def\GreHEpisemusBridge#1#2{%
  \ifgre@hepisemusbridge%
    \ifcase#2 %
      \gre@calculate@glyphraisevalue{#1}{9}%
    \or %
      \gre@calculate@glyphraisevalue{#1}{5}%
    \fi %
    \raise\gre@dimen@glyphraisevalue\hbox to 0pt{\gregoriofont\gre@char@he@punctum{f}\hss}%
  \fi %
  \relax %
}%

% another dumb top function
\def\GreAdditionalLine#1#2#3{%
  \ifgre@showlines %
    \xdef\gresavedglyphraise{\the\gre@dimen@glyphraisevalue}%
    \gre@style@additionalstafflines %
    \grehepisorline{\gre@pitch@a}{#1}{#2}{#3}{f}%
    \endgre@style@additionalstafflines%
    \gre@dimen@glyphraisevalue=\gresavedglyphraise %
  \fi %
  \relax %
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of bars
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% we define two types of macro for each four bar : when it is inside a syllable, and when it is not

\def\GreInVirgula#1{%
  \grewritebar{0}{1}{#1}%
  \relax%
}%

\def\GreVirgula#1{%
  \grewritebar{0}{0}{#1}%
  \relax%
}%

\def\GreInDivisioMinima#1{%
  \grewritebar{1}{1}{#1}%
  \relax%
}%

\def\GreDivisioMinima#1{%
  \grewritebar{1}{0}{#1}%
  \relax%
}%

\def\GreInDivisioMinor#1{%
  \grewritebar{2}{1}{#1}%
  \relax%
}%

\def\GreDivisioMinor#1{%
  \grewritebar{2}{0}{#1}%
  \relax%
}%

\def\GreInDivisioMaior#1{%
  \grewritebar{3}{1}{#1}%
  \relax%
}%

\def\GreDivisioMaior#1{%
  \grewritebar{3}{0}{#1}%
  \relax%
}%

\def\GreDominica#1#2{%
  \ifcase#1\or %
    \grewritebar{6}{0}{#2}%
  \or %
    \grewritebar{7}{0}{#2}%
  \or %
    \grewritebar{8}{0}{#2}%
  \or %
    \grewritebar{9}{0}{#2}%
  \or %
    \grewritebar{10}{0}{#2}%
  \or %
    \grewritebar{11}{0}{#2}%
  \fi %
  \relax%
}%

\def\GreInDominica#1#2{%
  \ifcase#1\or %
    \grewritebar{6}{1}{#2}%
  \or %
    \grewritebar{7}{1}{#2}%
  \or %
    \grewritebar{8}{1}{#2}%
  \or %
    \grewritebar{9}{1}{#2}%
  \or %
    \grewritebar{10}{1}{#2}%
  \or %
    \grewritebar{11}{1}{#2}%
  \fi %
  \relax%
}%


\def\GreInDivisioFinalis#1{%
  \ifcase\greendofscore %
    \grewritebar{4}{1}{#1}%
  \or %
    \grewritebar{5}{1}{#1}%
  \fi %
  \relax%
}%

\def\GreDivisioFinalis#1{%
  \ifcase\greendofscore %
    \grewritebar{4}{0}{#1}%
  \or %
    \grewritebar{5}{0}{#1}%
  \fi %
  \relax%
}%

%a macro to write a bar
%% 1: the type of the bar : 0 for virgula, 1 for minima 2 for minor, 3 for major, 4 for finalis and 5 for the last finalis
%% 2: is % for now we don't use it
%%%%%% 0 if it is in a syllable containing only this bar
%%%%%% 1 if it is in a syllable containing other notes
%% 3: macros that may happen before the skip after the bar (typically GreVEpisemus)
\def\grewritebar#1#2#3{%
  % first, for the bar to be really centered, if the last glyph has a punctum
  % mora, we kern of the corresponding space. We do it only in the case
  % of a bar in the middle of other notes.
  \ifnum\grelastispunctum=1\relax %
    \ifnum#2=1\relax %
      \setbox\gre@box@temp@width=\hbox{\gregoriofont\grepunctummorachar}%
      \gre@skip@temp@four = -\wd\gre@box@temp@width %
      \kern\gre@skip@temp@four%
      \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
      \kern\gre@skip@temp@four %
    \fi %
  \fi %
  \grenewglyphcommon %
  \gre@calculate@glyphraisevalue{\gre@pitch@g}{0}% bar glyphs are made to be at this height
  \grenobreak %
  \ifcase#1 % 0 : virgula
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@virgula}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@virgula}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 1 : minima
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiominima}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiominima}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 2 : minor
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiominor}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiominor}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 3 : maior
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundmaior%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiomaior}%
    \gredivisiomaiorsymbol %
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundmaior%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 4 : finalis
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundfinalis%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gredivisiofinalissymbol}%
    #3\relax %
    \gredivisiofinalissymbol%
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundfinalis%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 5 : finalis
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacebeforefinalfinalis%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gredivisiofinalissymbol}%
    #3\relax %
    \gredivisiofinalissymbol%
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundfinalis%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 6 : dominican bar 1
    \gre@calculate@glyphraisevalue{\gre@pitch@e}{0}%
    % we need to adjust the height of the bar a little so that it is perfectly aligned with the bottom (or the top for some bars) of the staff line, which is not the case by default if \gre@stafflinefactor is not 10.
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiodominican}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiodominican}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 7 : dominican bar 2
    \gre@calculate@glyphraisevalue{\gre@pitch@e}{0}%
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiodominicanalt}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiodominicanalt}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 8 : dominican bar 3
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflinediff %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiodominican}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiodominican}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 9 : dominican bar 4
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@stafflinediff %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiodominicanalt}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiodominicanalt}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 10 : dominican bar 5
    \gre@calculate@glyphraisevalue{\gre@pitch@i}{0}%
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiodominican}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiodominican}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 11 : dominican bar 6
    \gre@calculate@glyphraisevalue{\gre@pitch@i}{0}%
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \grenobreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiodominicanalt}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiodominicanalt}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \fi %
  \gre@debugmsg{spacing}{Width of bar just printed: \the\wd\gre@box@temp@width}%
  \global\gre@dimen@lastglyphwidth=\wd\gre@box@temp@width %
  \directlua{gregoriotex.adjust_line_height(\greinsidediscretionary)}%
  \relax%
}%

\def\gredivisiomaiorsymbol{%
  \ifnum\gre@stafflinefactor=17\relax %
    %\gre@calculate@glyphraisevalue{\gre@pitch@g}{0}% bar glyphs are made to be at this height
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\gre@char@divisiomaior}%
  \else %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@char@divisiomaior}%
    % we calculate the raise of the bar
    \gre@dimen@temp@five=\gre@dimen@additionalbottomspace %
    \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
    \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
    % we calculate the height of the bar
    \raise\gre@dimen@temp@five\hbox{\vrule height \gre@dimen@staffheight width \wd\gre@box@temp@width}%
  \fi %
  \relax %
}%

\def\gredivisiofinalissymbol{%
  \gre@calculate@glyphraisevalue{\gre@pitch@g}{0}% bar glyphs are made to be at this height
  \gredivisiomaiorsymbol %
  \gre@dimen@temp@four = 12000 sp%
  \multiply\gre@dimen@temp@four by \the\grefactor%
  \kern\gre@dimen@temp@four%
  \grenobreak %
  \gredivisiomaiorsymbol %
}%

%a count to tell if we have to keep the localrightbox until the end
\newcount\keeprightbox%

%macro to end a line with a divisio finalis
\def\GreFinalDivisioFinalis#1{%
  \grelocalrightbox{}%
  %\grelocalleftbox{}
  \grenobreak %
  \gre@skip@temp@four = \gre@skip@spacebeforefinalfinalis%
  \grehskip\gre@skip@temp@four %
  \grenobreak %
  \GreBarSyllable{}{}{}{1}{}{}{0}{\GreLastOfLine}{%
    \grenobreak %
    \GreDivisioFinalis{}%
    #1%
  }%
  \relax%
}%

%macro to end a line with a divisio maior
\def\GreFinalDivisioMaior#1{%
  \grelocalrightbox{}%
  \grelocalleftbox{}%
    \GreBarSyllable{}{}{}{1}{}{}{0}{}{%
    \grenobreak %
    \GreDivisioMaior{}%
    #1%
  }%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for filling holes of empty notes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% flag to indicate that lines behind a punctum cavum should be hidden
\newif\ifgre@hidepclines
% default state is to not hide them
\gre@hidepclinesfalse

% macro for manipulating above flag
\def\gresetlinesbehindpunctumcavum#1{%
  \IfStrEq{#1}{visible}%
    {\gre@hidepclinesfalse}%
    {\IfStrEq{#1}{invisible}%
      {\gre@hidepclinestrue}%
      {\greerror{Unrecognized option for \protect\gresetlinesbehindpunctumcavum}}%
    }%
}%

\def\GreHidePCLines{%
  \gre@deprecated{\protect\GreHidePCLines}{\protect\gresetlinesbehindpunctumcavum{invisible}}%
  \gre@hidepclinestrue%
}%

\def\GreDontHidePCLines{%
  \gre@deprecated{\protect\GreDontHidePCLines}{\protect\gresetlinesbehindpunctumcavum{visible}}%
  \gre@hidepclinesfalse%
}%

% flag to indicate that lines behind an alteration should be hidden
\newif\ifgre@hidealtlines
% default state is to not hide them
\gre@hidealtlinesfalse

% macro for manipulating above flag
\def\gresetlinesbehindalteration#1{%
  \IfStrEq{#1}{visible}%
    {\gre@hidealtlinesfalse}%
    {\IfStrEq{#1}{invisible}%
      {\gre@hidealtlinestrue}%
      {\greerror{Unrecognized option for \protect\gresetlinesbehindalteration}}%
    }%
}%

\def\GreHideAltLines{%
  \gre@deprecated{\protect\GreHideAltLines}{\protect\gresetlinesbehindalteration{invisible}}%
  \gre@hidealtlinestrue%
}%

\def\GreDontHideAltLines{%
  \gre@deprecated{\protect\GreDontHideAltLines}{\protect\gresetlinesbehindalteration{visible}}%
  \gre@hidealtlinesfalse%
}%


% the argument is the character with which we fill the hole, and we suppose that
% isonaline and glyphraisevalue are correctly set.
\def\grefillhole#1{%
  \setbox\gre@box@temp@width=\hbox{#1}%
  \hbox to 0pt{%
    {%
    \color{grebackgroundcolor}%
    \raise \gre@dimen@glyphraisevalue %
    \copy\gre@box@temp@width %
    }%
    %\pdfliteral{}% this is a ugly hack for old versions of LuaTeX to work
    \hss %
  }%
  \grenobreak %
\relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for typesetting alterations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a count saying if the first glyph is an alteration
\newcount\grefirstisalteration%

% the top level macro:
% #1 is the height
% #2 is the char of the alteration
% #3 is the char of the alteration hole
% #4 is 1 in the case of a flat for a key change, 0 otherwise
\def\grealteration#1#2#3#4{%
  % to see why we reset \grelastoflinecount, see comments of \GreGlyph.
  \ifnum#4=0\relax %
    \grenewglyphcommon %
    \ifnum\the\grefirstglyph=1\relax %
      \global\grefirstisalteration=1\relax %
    \fi %
  \fi %
  \gre@calculate@glyphraisevalue{#1}{0}%
  \ifgre@hidealtlines %
    \grefillhole{#3}%
  \fi %
  \setbox\gre@box@temp@width=\hbox{#2}%
  %\gre@dimen@temp@three=\wd\gre@box@temp@width 
  %\kern\gre@dimen@temp@three 
  %#3\relax 
  %\kern-\gre@dimen@temp@three 
  \raise \gre@dimen@glyphraisevalue%
  \copy\gre@box@temp@width%
  \ifnum#4=0\relax %
    % we try to avoid line breaking after a flat or a natural
    \grenobreak %
    \gre@skip@temp@four = \gre@skip@alterationspace%
    \ifnum\the\grefirstglyph=1\relax %
      \global\advance\gre@dimen@notesaligncenter by \wd\gre@box@temp@width %
      \global\advance\gre@dimen@notesaligncenter by \dimexpr\gre@skip@temp@four\relax %
      \kern\gre@skip@temp@four %
    \else %
      \grehskip\gre@skip@temp@four %
    \fi %
    \grenobreak %
  \fi %
  %#4\relax 
  %\grenobreak 
  \relax %
}%
  %
% This macro typesets a flat on the height provided by #1. #2 is not used yet, but it
% will determine if the flat has zero width or not. #3 and #4 should be the same as GreGlyph's #5 and #6, but it's not really done nor useful...

\def\GreFlat#1#2{%
  \grealteration{#1}{\greflatchar}{\greflatholechar}{#2}%
  \relax%
}%

% Same as the one before, but for naturals.

\def\GreNatural#1#2{%
  \grealteration{#1}{\grenaturalchar}{\grenaturalholechar}{#2}%
  \relax%
}%

% Same as the one before, but for sharps.

\def\GreSharp#1#2{%
  \grealteration{#1}{\gresharpchar}{\gresharpholechar}{#2}%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for typesetting punctum cavum
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grepunctumcavumchar{\gregoriofont\gre@char@punctumcavum}%
\def\grelineapunctumcavumchar{\gregoriofont\gre@char@lineapunctumcavum}%
\def\grepunctumcavumholechar{\gregoriofont\gre@char@punctumcavumhole}%
\def\grelineapunctumcavumholechar{\gregoriofont\gre@char@lineapunctumcavumhole}%

\def\gresetpunctumcavum#1{%
  \IfStrEq{#1}{alternate}%
    {%
      \grechangeglyph{PunctumCavum}{greciliae}{.caeciliae}%
      \grechangeglyph{LineaPunctumCavum}{greciliae}{.caeciliae}%
      \grechangeglyph{PunctumCavumHole}{greciliae}{.caeciliae}%
      \grechangeglyph{LineaPunctumCavumHole}{greciliae}{.caeciliae}%
    }%
    {\IfStrEq{#1}{normal}%
      {%
        \greresetglyph{PunctumCavum}%
        \greresetglyph{LineaPunctumCavum}%
        \greresetglyph{PunctumCavumHole}%
        \greresetglyph{LineaPunctumCavumHole}%
      }%
      {\greerror{Unrecognized option for \protect\gresetpunctumcavum}}%
    }%
}%	


\def\UseAlternatePunctumCavum{%
  \gre@deprectated{\protect\UseAlternatePunctumCavum}{\protect\gresetpuncutmcavum{alternate}} %
  \gresetpunctumcavum{alternate}%
}%

\def\UseNormalPunctumCavum{%
  \gre@deprectated{\protect\UseNormalPunctumCavum}{\protect\gresetpuncutmcavum{normal}} %
  \gresetpunctumcavum{normal}%
}%

\def\GrePunctumCavum#1#2#3#4#5{%
  \setbox\gre@box@temp@width=\hbox{\grepunctumcavumchar}%
  \global\gre@dimen@lastglyphwidth=\wd\gre@box@temp@width %
  \gre@skip@temp@four = \gre@dimen@lastglyphwidth%
  \kern\gre@skip@temp@four %
  #4\relax %
  \kern-\gre@skip@temp@four %
  \gre@calculate@glyphraisevalue{#1}{0}%
  \ifgre@hidepclines%
    \grefillhole{\grepunctumcavumholechar}%
  \fi %
  \GreGlyph{\grepunctumcavumchar}{#1}{#2}{#3}{}{#5}%
  \relax %
}%

\def\GreLineaPunctumCavum#1#2#3#4#5{%
  \setbox\gre@box@temp@width=\hbox{\grelineapunctumcavumchar}%
  \global\gre@dimen@lastglyphwidth=\wd\gre@box@temp@width %
  \gre@skip@temp@four = \gre@dimen@lastglyphwidth%
  \kern\gre@skip@temp@four %
  #4\relax %
  \kern-\gre@skip@temp@four %
  \gre@calculate@glyphraisevalue{#1}{0}%
  \ifgre@hidepclines %
    \grefillhole{\grelineapunctumcavumholechar}%
  \fi %
  \GreGlyph{\grelineapunctumcavumchar}{#1}{#2}{#3}{}{#5}%
  \relax %
}%
