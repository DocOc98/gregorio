% GregorioTeX boostrap file for Plain TeX
%
% Copyright (C) 2015 The Gregorio Project (see CONTRIBUTORS.md)
%
% This file is part of Gregorio.
%
% Gregorio is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% Gregorio is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Gregorio.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions for lines, initial, fonts, etc.

\edef\greoldcatcode{\the\catcode`@}
\catcode`\@=11

\input ifluatex.sty%
\input luatexbase.sty%
\input luaotfload.sty%
\input graphicx.tex % for \resizebox
\input xstring.sty%

\def\greerror#1{\begingroup%
\def\MessageBreak{^^J}%
\let\protect\string%
\errmessage{GregorioTeX error: #1}%
\endgroup}%

\def\gre@warning#1{\begingroup%
\def\MessageBreak{^^J}%
\let\protect\string%
\message{GregorioTeX warning: #1}%
\endgroup}%

\def\gre@bug#1{\begingroup%
\def\MessageBreak{^^J}%
\let\protect\string%
\errmessage{GregorioTeX bug: #1 !! This is a bug in Gregorio.  Please report it at https://github.com/gregorio-project/gregorio/issues}%
\endgroup}%


\ifx\csname gre@debug\endcsname\relax%
\else%
  \def\gre@debug{}%
\fi%

\ifx\csname f@size\endcsname\relax%
\else%
  \def\f@size{\directlua{gregoriotex.font_size()}}%
\fi%

\input gregoriotex-main.tex

%%%%%%%%%
%% PlainTeX specific definitions for fonts
%%%%%%%%%

\def\GreBold#1{%
  {\bf #1}%
  \relax %
}%

\def\GreItalic#1{%
  {\it #1}%
  %\relax 
}%

\def\GreSmallCaps#1{%
  {\sc #1}%
  \relax %
}%

\def\GreTypewriter#1{%
  {\tt #1}%
  \relax %
}%

% Note since underlining and coloring donâ€™t exist in PlainTeX, but we need the following commands to maintain compatibility with LaTeX.
\def\GreUnderline#1{%
  \gre@warning{Underlining cannot be done in PlainTeX}%
  {#1}%
  \relax %
}%

\def\GreColored#1{%
  \gre@warning{Text color cannot be changed in PlainTeX}%
  {#1}%
  \relax %
}%

%%%%%%%%%%%%%%%
%% Line color
%%%%%%%%%%%%%%%

% Colors don't work in PlainTeX, but we need these functions for interoperability with LaTeX.

\def\gresetlinecolor#1{%
  \gre@warning{Line color cannot be changed in PlainTeX}%
  \relax%
}


\def\grecoloredlines#1{%
  \gre@deprecated{\protect\greredlines}{\protect\gresetlinecolor}%
  \relax %
}

\def\greredlines{%
  \gre@deprecated{\protect\greredlines}{\protect\gresetlinecolor{gregoriocolor}}%
  \gresetlinecolor{gregoriocolor}%
  \relax %
}

\let\redlines\greredlines

\def\grenormallines{%
  \gre@deprecated{\protect\grenormallines}{\protect\gresetlinecolor{black}}%
  \gresetlinecolor{black}%
  \relax %
}

\let\normallines\grenormallines


%% The following two functions are defined for backwards compatibility.  They will eventually be removed.
\def\greinitialformat#1{%
  {\gre@fontofinitial #1}%
  \relax %
}%

\def\grebiginitialformat#1{%
  {\gre@fontofbiginitial #1}%
  \relax %
}

%%%%%%%%%%%%%%%%%%%%
%% Formatting environments
%%%%%%%%%%%%%%%%%%%%

\font\gre@fontofbiginitial=pncr at 80pt%
\font\gre@fontofinitial=pncr at 40pt%

\def\gre@style@initial{%
  \begingroup%
  \gre@fontofinitial%
  \relax %
}%
\def\endgre@style@initial{\endgroup}%

\def\gre@style@biginitial{%
  \begingroup%
  \gre@fontofbiginitial%
  \relax %
}%
\def\endgre@style@biginitial{\endgroup}%

\def\gre@style@translation{%
  \begingroup%
  \it%
}%
\def\endgre@style@translation{\endgroup}%

\def\gre@style@abovelinestext{%
  \begingroup%
  \it%
}%
\def\endgre@style@abovelinestext{\endgroup}%

\def\gre@style@normalstafflines{%
  \begingroup%
  \relax%
}%
\def\endgre@style@normalstafflines{\endgroup}%

\def\gre@style@additionalstafflines{%
  \begingroup%
  \gre@style@normalstafflines%
}%
\def\endgre@style@additionalstafflines{%
  \endgre@style@normalstafflines%
  \endgroup%
}%

\def\gre@style@lowchoralsign{%
  \begingroup%
  \relax%
}%
\def\endgre@style@lowchoralsign{\endgroup}%

\def\gre@style@highchoralsign{%
  \begingroup%
  \relax%
}%
\def\endgre@style@highchoralsign{\endgroup}%

\def\gre@style@firstsyllableinitial{%
  \begingroup%
  \relax%
}%
\def\endgre@style@firstsyllableinitial{\endgroup}%

\def\gre@style@firstsyllable{%
  \begingroup%
  \relax%
}%
\def\endgre@style@firstsyllable{\endgroup}%

\def\gre@changestyle#1#2[#3]{%
  \gdef\csname gre@style@#1\endcsname{\begingroup#2}%
  \gdef\csname endgre@style@#1\endcsname{#3\endgroup}%
}%

\catcode`\@=\greoldcatcode
